<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="Scripts/d3.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>
<script>

const netflixData = (callback) => {
  d3.csv("Data/netflix_titles.csv").then((data) => {
    let dataset = data
      .filter((d) => d.type && d.release_year && d.rating)
      .map((d) => {
        // Split the country string into an array of countries
        const countries = d.country ? d.country.split(",") : [];
        const genres = d.listed_in ? d.listed_in.split(",") : [];

        return {
          show_id: d.show_id,
          type: d.type,
          title: d.title,
          director: d.director,
          cast: d.cast,
          country: countries.map((c) => c.trim()), // Trim whitespaces
          date_added: d.date_added,
          release_year: parseInt(d.release_year),
          rating: d.rating,
          duration: d.duration,
          listed_in: genres.map((g) => g.trim()), // Trim whitespaces
          description: d.description,
        };
      });
    callback(dataset);
  });
};

netflixData((data) => {
  // Extracting unique countries
  const uniqueCountries = new Set();
  const uniqueGenres = new Set();
  const countryTitleCount = {}; // Object to store title count for each country
  

  data.forEach((d) => {
    d.country.forEach((c) => {
      const trimmedCountry = c.trim();
      uniqueCountries.add(trimmedCountry);

      // Increment title count for the country in the object
      countryTitleCount[trimmedCountry] =
        (countryTitleCount[trimmedCountry] || 0) + 1;
    });
  });

  const totalTitles = data.length;
  d3.select("#TotalTitleNumber").text(totalTitles);

  data.forEach((d) => {
    d.country.forEach((c) => uniqueCountries.add(c));
    d.listed_in.forEach((g) => uniqueGenres.add(g));
  });

  ///
  ////
  /////
  //////
  /////// 3eme graph
  //////
  /////
  ////
  ///

  const movieGenreCount = {};
  const TvShowGenreCount = {};

  data.forEach((d) => {
    const releaseYear = d.release_year;
    const genres = d.listed_in;
    const type = d.type;

    genres.forEach((genre) => {
      if (releaseYear >= 2010 && releaseYear <= 2020) {
        if (type === "Movie") {
          movieGenreCount[genre] = movieGenreCount[genre] || {};
          movieGenreCount[genre][releaseYear] =
          movieGenreCount[genre][releaseYear] || 0;
          movieGenreCount[genre][releaseYear] += 1;
        } else if (type === "TV Show") {
          TvShowGenreCount[genre] = TvShowGenreCount[genre] || {};
          TvShowGenreCount[genre][releaseYear] =
          TvShowGenreCount[genre][releaseYear] || 0;
          TvShowGenreCount[genre][releaseYear] += 1;
        }
      }
    });
  });

  const genres = Object.keys(movieGenreCount);
  const genres2 = Object.keys(TvShowGenreCount);


  const releaseYears = [...new Set(data.map((d) => d.release_year))]
    .filter((year) => year >= 2010 && year <= 2020)
    .sort((a, b) => a - b);

  const totalGenres = uniqueGenres.size;
  d3.select("#TotalGenresNumber").text(totalGenres);

  const filteredData = data.filter(
    (d) => d.release_year >= 2000 && d.release_year < 2024
  );

  const margin = { top: 20, right: 20, bottom: 40, left: 45 };
  const width = 550 - margin.left - margin.right;
  const height = 400 - margin.top - margin.bottom;

  let currentState = "All";
  const states = ["All", "Movie", "TV Show"];
  const movieData = filteredData.filter((entry) => entry.type === "Movie");
  const movieDurations = movieData.map((entry) => entry.duration);

  // Assuming duration is in the format "X min", extracting only the numeric part
  const durationValues = movieDurations.map((duration) => parseInt(duration.split(" ")[0])).filter((duration) => !isNaN(duration));

  const durationCount = {};

  durationValues.forEach((duration) => {
    // Increment the count for the current duration
    durationCount[duration] = (durationCount[duration] || 0) + 1;
  });

  // Display the count for each duration
  Object.keys(durationCount).forEach((duration) => {
    console.log(`${duration}: ${durationCount[duration]} titles`);
  });
  


  const svg5 = d3.select("#my_dataviz")
  .append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  const x5 = d3.scaleLinear()
  .domain([0, d3.max(durationValues)])
  .range([0, width]);

const y5 = d3.scaleLinear()
  .domain([0, d3.max(Object.values(durationCount))])
  .range([height, 0]);


  svg5.append("path")
  .datum(Object.entries(durationCount))
  .attr("fill", "#cce5df")
  .attr("stroke", "#69b3a2")
  .attr("stroke-width", 1.5)
  .attr("d", d3.area()
    .x(d => x5(+d[0]))
    .y0(height)
    .y1(d => y5(+d[1]))
  );

  svg5.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x5));

svg5.append("g")
  .call(d3.axisLeft(y5));

});

</script>
